<!DOCTYPE html>
<!--
**  Vingester Web UI Dashboard
**  Copyright (c) 2021-2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
**  Licensed under GPL 3.0 <https://spdx.org/licenses/GPL-3.0-only>
-->
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Vingester</title>
    <style>
        :root {
            --bg:           #0d1117;
            --surface:      #161b22;
            --surface2:     #21262d;
            --border:       #30363d;
            --border-hi:    #388bfd;
            --text:         #e6edf3;
            --text-muted:   #8b949e;
            --text-subtle:  #484f58;
            --accent:       #388bfd;
            --accent-dim:   #1f3a6e;
            --success:      #3fb950;
            --success-dim:  #1a3a1f;
            --danger:       #f85149;
            --danger-dim:   #3a1a1a;
            --warning:      #d29922;
            --purple:       #a371f7;
            --purple-dim:   #2a1a4e;
            --running-col:  #3fb950;
            --stopped-col:  #f85149;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
        }

        /* ── HEADER ─────────────────────────────────────────────── */
        #app-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            height: 52px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-logo {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .header-logo .logo-icon {
            width: 22px; height: 22px;
            background: var(--accent);
            border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px;
            color: #fff;
            flex-shrink: 0;
        }
        .header-divider { width: 1px; height: 20px; background: var(--border); }
        #conn-status {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #conn-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--text-subtle);
            transition: background 0.3s;
        }
        #conn-dot.ok  { background: var(--success); }
        #conn-dot.err { background: var(--danger); }
        .header-spacer { flex: 1; }
        .btn-add-instance {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: opacity 0.15s;
        }
        .btn-add-instance:hover { opacity: 0.85; }

        /* ── TABS ────────────────────────────────────────────────── */
        #tab-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            display: flex;
            gap: 0;
        }
        .tab-btn {
            padding: 11px 16px;
            font-size: 13px;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.15s, border-color 0.15s;
            user-select: none;
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--text); border-bottom-color: var(--accent); }

        /* ── LAYOUT ──────────────────────────────────────────────── */
        .page { padding: 20px; max-width: 1280px; margin: 0 auto; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* ── TOOLBAR ─────────────────────────────────────────────── */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .toolbar-sep { flex: 1; }

        /* ── BUTTONS ─────────────────────────────────────────────── */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid;
            transition: background 0.15s, color 0.15s, opacity 0.15s;
            text-decoration: none;
            white-space: nowrap;
        }
        .btn:disabled, .btn.disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .btn-ghost   { border-color: var(--border); color: var(--text-muted); background: transparent; }
        .btn-ghost:hover { background: var(--surface2); color: var(--text); }
        .btn-start   { border-color: var(--success);  color: var(--success);  background: transparent; }
        .btn-start:hover  { background: var(--success);  color: #fff; }
        .btn-stop    { border-color: var(--danger);   color: var(--danger);   background: transparent; }
        .btn-stop:hover   { background: var(--danger);   color: #fff; }
        .btn-reload  { border-color: var(--border);   color: var(--text-muted); background: transparent; }
        .btn-reload:hover { background: var(--surface2); color: var(--text); }
        .btn-edit    { border-color: var(--border);   color: var(--text-muted); background: transparent; }
        .btn-edit:hover   { background: var(--surface2); color: var(--text); }
        .btn-delete  { border-color: transparent;     color: var(--text-subtle); background: transparent; }
        .btn-delete:hover { color: var(--danger); }
        .btn-primary { border-color: var(--accent);   color: #fff; background: var(--accent); }
        .btn-primary:hover { opacity: 0.85; }
        .btn-danger  { border-color: var(--danger);   color: #fff; background: var(--danger); }
        .btn-danger:hover { opacity: 0.85; }
        .btn-sm { padding: 3px 8px; font-size: 11px; }
        .btn-icon { padding: 4px 7px; }

        /* ── INSTANCE GRID ───────────────────────────────────────── */
        #instances-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
        }
        .inst-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            transition: border-color 0.2s;
            position: relative;
        }
        .inst-card.running { border-left: 3px solid var(--success); }
        .inst-card.stopped { border-left: 3px solid var(--stopped-col); }
        .inst-card-head {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .inst-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--stopped-col);
            flex-shrink: 0;
            transition: background 0.3s;
        }
        .inst-dot.running {
            background: var(--running-col);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50%       { opacity: 0.4; }
        }
        .inst-title {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .inst-state-label {
            font-size: 11px;
            color: var(--text-subtle);
            flex-shrink: 0;
        }
        .inst-state-label.running { color: var(--success); }
        .inst-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .inst-url {
            font-size: 11px;
            color: var(--accent);
            font-family: ui-monospace, monospace;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 10px;
        }
        .inst-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }
        .badge {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 4px;
            background: var(--surface2);
            color: var(--text-muted);
            border: 1px solid var(--border);
            white-space: nowrap;
        }
        .badge-ndi    { background: var(--success-dim);  color: var(--success);  border-color: transparent; }
        .badge-auto   { background: var(--accent-dim);   color: var(--accent);   border-color: transparent; }
        .badge-start  { background: var(--purple-dim);   color: var(--purple);   border-color: transparent; }
        .inst-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        .inst-actions-spacer { flex: 1; }

        /* ── EMPTY / LOADING ─────────────────────────────────────── */
        .state-msg {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-subtle);
            font-size: 13px;
        }
        .state-msg .state-icon { font-size: 2rem; margin-bottom: 10px; opacity: 0.4; }
        .error-banner {
            background: var(--danger-dim);
            border: 1px solid var(--danger);
            border-radius: 6px;
            padding: 10px 14px;
            color: var(--danger);
            font-size: 13px;
            margin-bottom: 14px;
            display: none;
        }

        /* ── MODAL OVERLAY ───────────────────────────────────────── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(3px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.18s, visibility 0.18s;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            width: 94%;
            max-width: 660px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: translateY(12px);
            transition: transform 0.18s;
            overflow: hidden;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal-header {
            padding: 16px 20px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .modal-title {
            font-size: 15px;
            font-weight: 600;
            flex: 1;
        }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            line-height: 1;
        }
        .modal-close:hover { background: var(--surface2); color: var(--text); }
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 20px;
            flex-shrink: 0;
            background: var(--surface);
        }
        .modal-tab {
            padding: 9px 14px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: color 0.15s, border-color 0.15s;
            user-select: none;
        }
        .modal-tab:hover { color: var(--text); }
        .modal-tab.active { color: var(--text); border-bottom-color: var(--accent); }
        .modal-body {
            overflow-y: auto;
            flex: 1;
            padding: 0;
        }
        .modal-tab-panel { display: none; padding: 18px 20px; }
        .modal-tab-panel.active { display: block; }
        .modal-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            flex-shrink: 0;
        }
        .modal-footer-left { margin-right: auto; }

        /* ── FORM ELEMENTS ───────────────────────────────────────── */
        .form-group { margin-bottom: 14px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .form-label .req { color: var(--danger); margin-left: 2px; }
        .form-hint {
            font-size: 11px;
            color: var(--text-subtle);
            margin-top: 3px;
        }
        .form-control {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text);
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.15s;
            outline: none;
        }
        .form-control:focus { border-color: var(--accent); }
        .form-control.mono { font-family: ui-monospace, monospace; font-size: 12px; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        select.form-control { appearance: none; cursor: pointer; }
        .form-row {
            display: grid;
            gap: 10px;
        }
        .form-row.col2 { grid-template-columns: 1fr 1fr; }
        .form-row.col3 { grid-template-columns: 1fr 1fr 1fr; }
        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .form-check input[type=checkbox] {
            width: 15px; height: 15px;
            accent-color: var(--accent);
            cursor: pointer;
            flex-shrink: 0;
        }
        .form-check-label {
            font-size: 13px;
            color: var(--text);
            user-select: none;
        }
        .form-checks-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .form-section {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 14px;
        }
        .form-section:last-child { margin-bottom: 0; }
        .form-section-head {
            background: var(--surface2);
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 0.3px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-section-body { padding: 14px 12px; }
        .collapse-body { display: none; }
        .collapse-body.open { display: block; }
        .input-with-btn { display: flex; gap: 6px; }
        .input-with-btn .form-control { flex: 1; }
        .radio-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .radio-btn {
            position: relative;
        }
        .radio-btn input[type=radio] {
            position: absolute;
            opacity: 0;
            width: 0; height: 0;
        }
        .radio-btn label {
            display: block;
            padding: 4px 12px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }
        .radio-btn input[type=radio]:checked + label {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        .color-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .color-swatch {
            width: 32px; height: 32px;
            border-radius: 5px;
            border: 1px solid var(--border);
            cursor: pointer;
            flex-shrink: 0;
            overflow: hidden;
        }
        .color-swatch input[type=color] {
            width: 100%; height: 100%;
            border: none;
            padding: 0;
            cursor: pointer;
            opacity: 0;
        }

        /* ── MEDIA PICKER MODAL ──────────────────────────────────── */
        #media-picker-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.15s, visibility 0.15s;
        }
        #media-picker-overlay.open { opacity: 1; visibility: visible; }
        #media-picker {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            width: 92%;
            max-width: 560px;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .picker-head {
            padding: 14px 18px 10px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .picker-title {
            font-size: 14px;
            font-weight: 600;
            flex: 1;
        }
        #picker-grid {
            overflow-y: auto;
            flex: 1;
            padding: 14px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            align-content: start;
        }
        .picker-item {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .picker-item:hover { border-color: var(--accent); }
        .picker-thumb {
            width: 100%; height: 80px;
            object-fit: cover;
            background: var(--surface2);
            display: block;
        }
        .picker-name {
            padding: 5px 6px;
            font-size: 11px;
            color: var(--text-muted);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ── MEDIA MANAGER ───────────────────────────────────────── */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 28px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent);
            background: rgba(56, 139, 253, 0.04);
        }
        .upload-zone input[type=file] { display: none; }
        .upload-icon { font-size: 28px; color: var(--text-subtle); margin-bottom: 6px; }
        .upload-text { font-size: 13px; color: var(--text-muted); }
        .upload-hint { font-size: 11px; color: var(--text-subtle); margin-top: 4px; }
        .upload-progress {
            background: var(--surface2);
            border-radius: 4px;
            height: 5px;
            margin-bottom: 6px;
            display: none;
        }
        .upload-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            width: 0;
            transition: width 0.15s;
        }
        .upload-progress-label {
            font-size: 11px;
            color: var(--text-subtle);
            margin-bottom: 10px;
            display: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }
        .media-item {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 7px;
            overflow: hidden;
            transition: border-color 0.15s;
        }
        .media-item:hover { border-color: var(--border-hi); }
        .media-thumb {
            width: 100%; height: 110px;
            object-fit: cover;
            display: block;
            background: var(--surface2);
        }
        .media-info {
            padding: 7px 9px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .media-name {
            flex: 1;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .media-size { font-size: 11px; color: var(--text-subtle); }
        .media-delete {
            background: none;
            border: none;
            color: var(--text-subtle);
            cursor: pointer;
            font-size: 13px;
            padding: 2px 4px;
            border-radius: 3px;
            line-height: 1;
        }
        .media-delete:hover { color: var(--danger); }

        /* ── STATUS BAR ──────────────────────────────────────────── */
        #status-bar {
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 5px 20px;
            font-size: 11px;
            color: var(--text-subtle);
            display: flex;
            gap: 14px;
            position: sticky;
            bottom: 0;
        }
        #status-bar span { color: var(--text-muted); }

        /* ── TOAST ───────────────────────────────────────────────── */
        #toast-container {
            position: fixed;
            bottom: 34px;
            right: 18px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .toast {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 9px 14px;
            font-size: 12px;
            max-width: 300px;
            animation: toastIn 0.22s ease;
        }
        .toast.success { border-color: var(--success); color: var(--success); }
        .toast.error   { border-color: var(--danger);  color: var(--danger);  }
        @keyframes toastIn {
            from { transform: translateX(60px); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        /* ── SCROLLBAR ───────────────────────────────────────────── */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

<!-- ── HEADER ──────────────────────────────────────────────────── -->
<header id="app-header">
    <div class="header-logo">
        <div class="logo-icon">&#9654;</div>
        Vingester
    </div>
    <div class="header-divider"></div>
    <div id="conn-status">
        <div id="conn-dot"></div>
        <span id="conn-label">Connecting&hellip;</span>
    </div>
    <div class="header-spacer"></div>
    <button class="btn-add-instance" data-action="openAddModal">&#43; Add Instance</button>
</header>

<!-- ── TABS ────────────────────────────────────────────────────── -->
<div id="tab-bar">
    <div class="tab-btn active" data-action="switchTab" data-panel="instances">Instances</div>
    <div class="tab-btn" data-action="switchTab" data-panel="media">Media</div>
</div>

<!-- ── PANELS ──────────────────────────────────────────────────── -->
<div class="page">

    <!-- Instances panel -->
    <div id="panel-instances" class="panel active">
        <div id="err-instances" class="error-banner"></div>
        <div class="toolbar">
            <button class="btn btn-start"  data-action="cmdAll" data-cmd="start">&#9654; Start All</button>
            <button class="btn btn-stop"   data-action="cmdAll" data-cmd="stop">&#9646;&#9646; Stop All</button>
            <button class="btn btn-reload" data-action="cmdAll" data-cmd="reload">&#8635; Reload All</button>
        </div>
        <div id="instances-loading" class="state-msg">
            <div class="state-icon">&#8635;</div>
            Loading instances&hellip;
        </div>
        <div id="instances-empty" class="state-msg" style="display:none">
            <div class="state-icon">&#9744;</div>
            No instances yet. Click <strong>+ Add Instance</strong> to create one.
        </div>
        <div id="instances-grid" style="display:none"></div>
    </div>

    <!-- Media panel -->
    <div id="panel-media" class="panel">
        <div id="err-media" class="error-banner"></div>
        <div class="upload-zone" id="upload-zone"
             onclick="document.getElementById('file-input').click()"
             ondragover="UI.onDragOver(event)"
             ondragleave="UI.onDragLeave()"
             ondrop="UI.onDrop(event)">
            <input type="file" id="file-input" multiple
                   accept="image/*,video/*"
                   onchange="UI.uploadFiles(this.files)"/>
            <div class="upload-icon">&#8679;</div>
            <div class="upload-text">Click or drag &amp; drop to upload</div>
            <div class="upload-hint">PNG, JPG, GIF, WEBP, BMP, SVG, MP4, WEBM, OGG, MOV &mdash; up to 500 MB</div>
        </div>
        <div class="upload-progress" id="upload-progress">
            <div class="upload-progress-bar" id="upload-progress-bar"></div>
        </div>
        <div class="upload-progress-label" id="upload-progress-label"></div>
        <div id="media-loading" class="state-msg">Loading media&hellip;</div>
        <div id="media-empty" class="state-msg" style="display:none">
            <div class="state-icon">&#9112;</div>
            No media files yet.
        </div>
        <div id="media-grid" class="media-grid" style="display:none"></div>
    </div>

</div><!-- .page -->

<!-- ── STATUS BAR ──────────────────────────────────────────────── -->
<div id="status-bar">
    <span id="status-count">—</span>
    <span id="status-running">—</span>
    <span id="status-time"></span>
</div>

<!-- ── EDIT / ADD INSTANCE MODAL ───────────────────────────────── -->
<div class="modal-overlay" id="edit-overlay">
    <div class="modal" id="edit-modal">
        <div class="modal-header">
            <div class="modal-title" id="edit-modal-title">Instance</div>
            <button class="modal-close" data-action="closeModal">&times;</button>
        </div>
        <div class="modal-tabs">
            <div class="modal-tab active" data-action="switchModalTab" data-tab="source">Source</div>
            <div class="modal-tab" data-action="switchModalTab" data-tab="display">Display</div>
            <div class="modal-tab" data-action="switchModalTab" data-tab="output">Output</div>
            <div class="modal-tab" data-action="switchModalTab" data-tab="behavior">Behavior</div>
        </div>
        <div class="modal-body">

            <!-- SOURCE TAB -->
            <div class="modal-tab-panel active" id="mtab-source">
                <div class="form-group">
                    <label class="form-label">Title <span class="req">*</span></label>
                    <input type="text" class="form-control" id="f-t" placeholder="My Browser"/>
                </div>
                <div class="form-group">
                    <label class="form-label">Info / Description</label>
                    <input type="text" class="form-control" id="f-i" placeholder="Optional note"/>
                </div>
                <div class="form-group">
                    <label class="form-label">Input Type</label>
                    <div class="radio-group">
                        <div class="radio-btn">
                            <input type="radio" name="inputType" id="it-url"       value="url"       onchange="UI.onInputTypeChange()">
                            <label for="it-url">URL</label>
                        </div>
                        <div class="radio-btn">
                            <input type="radio" name="inputType" id="it-image"     value="image"     onchange="UI.onInputTypeChange()">
                            <label for="it-image">Image</label>
                        </div>
                        <div class="radio-btn">
                            <input type="radio" name="inputType" id="it-video"     value="video"     onchange="UI.onInputTypeChange()">
                            <label for="it-video">Video</label>
                        </div>
                        <div class="radio-btn">
                            <input type="radio" name="inputType" id="it-slideshow" value="slideshow" onchange="UI.onInputTypeChange()">
                            <label for="it-slideshow">Slideshow</label>
                        </div>
                    </div>
                </div>
                <!-- URL input -->
                <div class="form-group" id="grp-url">
                    <label class="form-label">URL</label>
                    <input type="text" class="form-control" id="f-u"
                           placeholder="https://example.com"/>
                </div>
                <!-- Files input (image / video / slideshow) -->
                <div class="form-group" id="grp-files" style="display:none">
                    <label class="form-label">File Path(s)</label>
                    <div class="input-with-btn">
                        <textarea class="form-control mono" id="f-if" rows="3"
                                  placeholder="One file path per line&#10;e.g. C:\Users\Me\image.png"></textarea>
                        <button class="btn btn-ghost btn-sm" style="align-self:flex-start;white-space:nowrap"
                                data-action="openMediaPicker">&#128247; Pick Media</button>
                    </div>
                    <div class="form-hint" id="media-dir-hint"></div>
                </div>
                <!-- Slideshow extras -->
                <div id="grp-slideshow" style="display:none">
                    <div class="form-row col2">
                        <div class="form-group">
                            <label class="form-label">Interval (seconds)</label>
                            <input type="text" class="form-control" id="f-si" value="5"/>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fade Duration (s)</label>
                            <input type="text" class="form-control" id="f-sf" value="1"/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DISPLAY TAB -->
            <div class="modal-tab-panel" id="mtab-display">
                <div class="form-row col3">
                    <div class="form-group">
                        <label class="form-label">Width (px)</label>
                        <input type="text" class="form-control" id="f-w" value="1280"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Height (px)</label>
                        <input type="text" class="form-control" id="f-h" value="720"/>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zoom</label>
                        <input type="text" class="form-control" id="f-z" value="1.0"/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Background Color</label>
                    <div class="color-row">
                        <div class="color-swatch" id="color-swatch">
                            <input type="color" id="color-picker" value="#000000"
                                   oninput="UI.onColorPicker(this.value)"/>
                        </div>
                        <input type="text" class="form-control" id="f-c"
                               value="transparent" placeholder="transparent or #rrggbb"
                               oninput="UI.onColorText(this.value)"/>
                    </div>
                    <div class="form-hint">Use <code>transparent</code> for alpha channel or a hex color.</div>
                </div>
                <div class="form-section" style="margin-top:8px">
                    <div class="form-section-head">Security &amp; Features</div>
                    <div class="form-section-body">
                        <div class="form-checks-grid">
                            <label class="form-check">
                                <input type="checkbox" id="f-H"/>
                                <span class="form-check-label">HTTPS Trust (allow self-signed)</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-I"/>
                                <span class="form-check-label">Node.js API access</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-B"/>
                                <span class="form-check-label">OBS DOM Emulation</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-S"/>
                                <span class="form-check-label">Persistent Session</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OUTPUT TAB -->
            <div class="modal-tab-panel" id="mtab-output">
                <!-- NDI -->
                <div class="form-section">
                    <div class="form-section-head">
                        <label class="form-check" style="margin:0">
                            <input type="checkbox" id="f-N" onchange="UI.onNdiToggle()"/>
                            <span class="form-check-label" style="font-weight:600;font-size:12px">NDI Output</span>
                        </label>
                    </div>
                    <div class="form-section-body collapse-body" id="ndi-collapse">
                        <div class="form-row col3">
                            <div class="form-group">
                                <label class="form-label">Frame Rate</label>
                                <input type="text" class="form-control" id="f-f" value="30"/>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Video Delay (ms)</label>
                                <input type="text" class="form-control" id="f-O" value="0"/>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Audio Delay (ms)</label>
                                <input type="text" class="form-control" id="f-o" value="0"/>
                            </div>
                        </div>
                        <div class="form-row col2">
                            <div class="form-group">
                                <label class="form-label">Audio Sample Rate</label>
                                <select class="form-control" id="f-r">
                                    <option value="8000">8 kHz</option>
                                    <option value="12000">12 kHz</option>
                                    <option value="16000">16 kHz</option>
                                    <option value="24000">24 kHz</option>
                                    <option value="48000" selected>48 kHz</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Audio Channels</label>
                                <select class="form-control" id="f-C">
                                    <option value="1">Mono (1)</option>
                                    <option value="2" selected>Stereo (2)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-checks-grid">
                            <label class="form-check">
                                <input type="checkbox" id="f-a"/>
                                <span class="form-check-label">Adaptive Frame Rate</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-n" checked/>
                                <span class="form-check-label">NDI Sink</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-v" checked/>
                                <span class="form-check-label">Alpha Channel</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-l"/>
                                <span class="form-check-label">Tally Reload</span>
                            </label>
                        </div>
                    </div>
                </div>
                <!-- FFmpeg -->
                <div class="form-section">
                    <div class="form-section-head">
                        <label class="form-check" style="margin:0">
                            <input type="checkbox" id="f-m" onchange="UI.onFfmpegToggle()"/>
                            <span class="form-check-label" style="font-weight:600;font-size:12px">FFmpeg Output</span>
                        </label>
                    </div>
                    <div class="form-section-body collapse-body" id="ffmpeg-collapse">
                        <div class="form-row col2">
                            <div class="form-group">
                                <label class="form-label">Mode</label>
                                <select class="form-control" id="f-R">
                                    <option value="vbr" selected>VBR (Variable)</option>
                                    <option value="abr">ABR (Average)</option>
                                    <option value="cbr">CBR (Constant)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Container Format</label>
                                <select class="form-control" id="f-F">
                                    <option value="matroska" selected>Matroska (MKV)</option>
                                    <option value="mp4">MP4</option>
                                    <option value="mpeg-ts">MPEG-TS</option>
                                    <option value="rtp">RTP</option>
                                    <option value="flv">FLV</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">FFmpeg Arguments</label>
                            <input type="text" class="form-control mono" id="f-M"
                                   placeholder="-vcodec h264 -b:v 4M ..."/>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BEHAVIOR TAB -->
            <div class="modal-tab-panel" id="mtab-behavior">
                <div class="form-section">
                    <div class="form-section-head">Startup</div>
                    <div class="form-section-body">
                        <div class="form-checks-grid">
                            <label class="form-check">
                                <input type="checkbox" id="f-as"/>
                                <span class="form-check-label">Auto-Start on launch</span>
                            </label>
                            <label class="form-check">
                                <input type="checkbox" id="f-ar" onchange="UI.onArToggle()"/>
                                <span class="form-check-label">Auto-Refresh</span>
                            </label>
                        </div>
                        <div id="ar-interval-grp" style="margin-top:10px;display:none">
                            <div class="form-group">
                                <label class="form-label">Refresh Interval (seconds)</label>
                                <input type="text" class="form-control" id="f-ai" value="300" style="max-width:120px"/>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-section-head">Patches</div>
                    <div class="form-section-body">
                        <div class="form-row col2">
                            <div class="form-group">
                                <label class="form-label">Patch Delay (ms)</label>
                                <input type="text" class="form-control" id="f-k" value="0"/>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Frame Selector (CSS)</label>
                                <input type="text" class="form-control mono" id="f-j" placeholder="#frame or body"/>
                            </div>
                        </div>
                        <div class="form-row col2" style="margin-top:4px">
                            <div class="form-group">
                                <label class="form-label">CSS Patch Type</label>
                                <select class="form-control" id="f-g" onchange="UI.onCssTypeChange()">
                                    <option value="inline">Inline Code</option>
                                    <option value="file">External File</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">JS Patch Type</label>
                                <select class="form-control" id="f-G" onchange="UI.onJsTypeChange()">
                                    <option value="inline">Inline Code</option>
                                    <option value="file">External File</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group" id="grp-css-code">
                            <label class="form-label">CSS Code</label>
                            <textarea class="form-control mono" id="f-q" rows="4"
                                      placeholder="body { background: transparent; }"></textarea>
                        </div>
                        <div class="form-group" id="grp-css-file" style="display:none">
                            <label class="form-label">CSS File Path</label>
                            <input type="text" class="form-control mono" id="f-q-file" placeholder="/path/to/style.css"/>
                        </div>
                        <div class="form-group" id="grp-js-code">
                            <label class="form-label">JS Code</label>
                            <textarea class="form-control mono" id="f-Q" rows="4"
                                      placeholder="// JavaScript injected into page"></textarea>
                        </div>
                        <div class="form-group" id="grp-js-file" style="display:none">
                            <label class="form-label">JS File Path</label>
                            <input type="text" class="form-control mono" id="f-Q-file" placeholder="/path/to/script.js"/>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- .modal-body -->
        <div class="modal-footer">
            <div class="modal-footer-left">
                <button class="btn btn-delete" id="btn-delete-inst" style="display:none"
                        data-action="deleteCurrentInstance">&#10005; Delete Instance</button>
            </div>
            <button class="btn btn-ghost" data-action="closeModal">Cancel</button>
            <button class="btn btn-primary" data-action="saveInstance">Save</button>
        </div>
    </div><!-- .modal -->
</div><!-- #edit-overlay -->

<!-- ── MEDIA PICKER MODAL ───────────────────────────────────────── -->
<div id="media-picker-overlay">
    <div id="media-picker">
        <div class="picker-head">
            <div class="picker-title">Pick from Media Library</div>
            <button class="modal-close" data-action="closeMediaPicker">&times;</button>
        </div>
        <div id="picker-grid"></div>
    </div>
</div>

<!-- ── TOASTS ────────────────────────────────────────────────────── -->
<div id="toast-container"></div>

<script>
"use strict";
(function () {
    const BASE = window.location.origin

    /* ──────────────────────────────────────────────────────────────
       UTILITIES
    ────────────────────────────────────────────────────────────── */
    function esc (str) {
        return String(str ?? "")
            .replace(/&/g, "&amp;").replace(/</g, "&lt;")
            .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
    }
    function fmtBytes (b) {
        if (b < 1024)         return b + " B"
        if (b < 1024 * 1024)  return (b / 1024).toFixed(1) + " KB"
        return (b / 1024 / 1024).toFixed(1) + " MB"
    }
    function toast (msg, type) {
        const c = document.getElementById("toast-container")
        const t = document.createElement("div")
        t.className = "toast " + (type || "")
        t.textContent = msg
        c.appendChild(t)
        setTimeout(() => t.remove(), 6000)
    }
    async function api (path, opts) {
        try {
            const res  = await fetch(BASE + path, opts || {})
            const text = await res.text()
            let data
            try { data = JSON.parse(text) } catch (e) { data = text }
            if (!res.ok) throw new Error(data?.message || data || "HTTP " + res.status)
            return { ok: true, data }
        } catch (err) {
            return { ok: false, error: err.message }
        }
    }
    function show (el)  { el.style.display = "" }
    function hide (el)  { el.style.display = "none" }
    function val  (id)  { return document.getElementById(id)?.value ?? "" }
    function chk  (id)  { return document.getElementById(id)?.checked ?? false }
    function setVal (id, v) { const el = document.getElementById(id); if (el) el.value = v }
    function setChk (id, v) { const el = document.getElementById(id); if (el) el.checked = !!v }

    /* ──────────────────────────────────────────────────────────────
       CONNECTION INDICATOR
    ────────────────────────────────────────────────────────────── */
    function setConn (ok) {
        const dot   = document.getElementById("conn-dot")
        const label = document.getElementById("conn-label")
        dot.className   = ok ? "ok" : "err"
        label.textContent = ok ? "Connected" : "Disconnected"
    }

    /* ──────────────────────────────────────────────────────────────
       TABS
    ────────────────────────────────────────────────────────────── */
    function switchTab (panel, el) {
        document.querySelectorAll(".tab-btn").forEach(t => t.classList.remove("active"))
        document.querySelectorAll(".panel").forEach(p => p.classList.remove("active"))
        el.classList.add("active")
        document.getElementById("panel-" + panel).classList.add("active")
        if (panel === "media")     loadMedia()
        if (panel === "instances") loadInstances()
    }

    /* ──────────────────────────────────────────────────────────────
       SEAMLESS INSTANCE GRID (DOM DIFFING)
    ────────────────────────────────────────────────────────────── */
    let instanceCache = {}   // id → last-seen instance data

    function buildBadges (inst) {
        const b = []
        if (inst.ndi)         b.push('<span class="badge badge-ndi">NDI</span>')
        if (inst.autoStart)   b.push('<span class="badge badge-start">Auto-Start</span>')
        if (inst.autoRefresh) b.push('<span class="badge badge-auto">Refresh ' + esc(inst.autoRefreshInterval) + 's</span>')
        b.push('<span class="badge">' + esc(inst.width) + '&times;' + esc(inst.height) + '</span>')
        b.push('<span class="badge">' + esc(inst.fps) + ' fps</span>')
        return b.join("")
    }

    function buildActionButtons (inst) {
        const frag = document.createDocumentFragment()
        const { id, running } = inst

        if (!running) {
            const btn = document.createElement("button")
            btn.className = "btn btn-start btn-sm"
            btn.innerHTML = "&#9654; Start"
            btn.addEventListener("click", function () { cmdInstance(id, "start") })
            frag.appendChild(btn)
        }
        if (running) {
            const s = document.createElement("button")
            s.className = "btn btn-stop btn-sm"
            s.innerHTML = "&#9646;&#9646; Stop"
            s.addEventListener("click", function () { cmdInstance(id, "stop") })
            frag.appendChild(s)

            const r = document.createElement("button")
            r.className = "btn btn-reload btn-sm"
            r.innerHTML = "&#8635; Reload"
            r.addEventListener("click", function () { cmdInstance(id, "reload") })
            frag.appendChild(r)
        }

        const spacer = document.createElement("span")
        spacer.className = "inst-actions-spacer"
        frag.appendChild(spacer)

        const edit = document.createElement("button")
        edit.className = "btn btn-edit btn-sm"
        edit.innerHTML = "&#9998; Edit"
        edit.addEventListener("click", function () { openEditModal(id) })
        frag.appendChild(edit)

        return frag
    }

    function createCard (inst) {
        const card = document.createElement("div")
        card.id = "card-" + inst.id
        card.className = "inst-card " + (inst.running ? "running" : "stopped")
        card.dataset.id = inst.id

        const urlText = inst.inputType !== "url"
            ? "(" + esc(inst.inputType) + ")"
            : esc(inst.url || "(no URL)")

        card.innerHTML = `
            <div class="inst-card-head">
                <div class="inst-dot ${inst.running ? "running" : ""}"></div>
                <div class="inst-title">${esc(inst.title)}</div>
                <div class="inst-state-label ${inst.running ? "running" : ""}">${inst.running ? "Running" : "Stopped"}</div>
            </div>
            ${inst.info ? '<div class="inst-info">' + esc(inst.info) + '</div>' : ''}
            <div class="inst-url">${urlText}</div>
            <div class="inst-badges">${buildBadges(inst)}</div>
            <div class="inst-actions"></div>
        `
        card.querySelector(".inst-actions").appendChild(buildActionButtons(inst))
        return card
    }

    function updateCard (inst) {
        const card = document.getElementById("card-" + inst.id)
        if (!card) return
        const prev = instanceCache[inst.id] || {}

        // Running state change → update dot, state label, card border, and action buttons
        if (prev.running !== inst.running) {
            card.className = "inst-card " + (inst.running ? "running" : "stopped")
            const dot   = card.querySelector(".inst-dot")
            const label = card.querySelector(".inst-state-label")
            dot.className   = "inst-dot" + (inst.running ? " running" : "")
            label.className = "inst-state-label" + (inst.running ? " running" : "")
            label.textContent = inst.running ? "Running" : "Stopped"
            const actions = card.querySelector(".inst-actions")
            actions.innerHTML = ""
            actions.appendChild(buildActionButtons(inst))
        }

        // Title change
        if (prev.title !== inst.title) {
            const el = card.querySelector(".inst-title")
            if (el) el.textContent = inst.title
        }

        // Info change
        if (prev.info !== inst.info) {
            const el = card.querySelector(".inst-info")
            if (el) el.textContent = inst.info || ""
        }

        // URL/inputType change
        if (prev.url !== inst.url || prev.inputType !== inst.inputType) {
            const el = card.querySelector(".inst-url")
            if (el) el.textContent = inst.inputType !== "url"
                ? "(" + inst.inputType + ")"
                : (inst.url || "(no URL)")
        }

        // Badges change (NDI, autoStart, autoRefresh, dimensions, fps)
        if (prev.ndi !== inst.ndi || prev.autoStart !== inst.autoStart
                || prev.autoRefresh !== inst.autoRefresh
                || prev.autoRefreshInterval !== inst.autoRefreshInterval
                || prev.width !== inst.width || prev.height !== inst.height
                || prev.fps !== inst.fps) {
            const el = card.querySelector(".inst-badges")
            if (el) el.innerHTML = buildBadges(inst)
        }
    }

    function reconcileGrid (instances) {
        const grid    = document.getElementById("instances-grid")
        const loading = document.getElementById("instances-loading")
        const empty   = document.getElementById("instances-empty")
        const errBox  = document.getElementById("err-instances")

        hide(loading)
        hide(errBox)

        if (instances.length === 0) {
            hide(grid)
            show(empty)
            instanceCache = {}
            grid.innerHTML = ""
            return
        }

        hide(empty)
        show(grid)

        const newIds = new Set(instances.map(i => i.id))
        const oldIds = new Set(Object.keys(instanceCache))

        // Remove deleted cards
        for (const id of oldIds) {
            if (!newIds.has(id)) {
                const el = document.getElementById("card-" + id)
                if (el) el.remove()
                delete instanceCache[id]
            }
        }

        // Maintain ordering — build ordered list of expected IDs
        const existingOrder = Array.from(grid.children).map(c => c.dataset.id)
        const newOrder      = instances.map(i => i.id)
        const needReorder   = newOrder.some((id, idx) => existingOrder[idx] !== id)

        for (const inst of instances) {
            if (!oldIds.has(inst.id)) {
                // New card
                grid.appendChild(createCard(inst))
            } else {
                updateCard(inst)
            }
            instanceCache[inst.id] = { ...inst }
        }

        // Re-order cards in DOM if needed
        if (needReorder) {
            for (const inst of instances) {
                const card = document.getElementById("card-" + inst.id)
                if (card) grid.appendChild(card)
            }
        }
    }

    async function loadInstances () {
        const result = await api("/api/instances")
        setConn(result.ok)

        if (!result.ok) {
            const errBox = document.getElementById("err-instances")
            errBox.textContent = "Failed to load instances: " + result.error
            show(errBox)
            return
        }

        const instances = result.data
        const running   = instances.filter(i => i.running).length
        document.getElementById("status-count").textContent   = instances.length + " instance" + (instances.length !== 1 ? "s" : "")
        document.getElementById("status-running").textContent = running + " running"
        document.getElementById("status-time").textContent    = "Updated " + new Date().toLocaleTimeString()

        reconcileGrid(instances)
    }

    async function cmdInstance (id, command) {
        const r = await api("/api/instances/" + id + "/" + command, { method: "POST" })
        if (r.ok) {
            toast(command.charAt(0).toUpperCase() + command.slice(1) + " sent", "success")
            await loadInstances()
        } else {
            toast("Error: " + r.error, "error")
        }
    }

    async function cmdAll (command) {
        const r = await api("/api/all/" + command, { method: "POST" })
        if (r.ok) {
            toast(command.charAt(0).toUpperCase() + command.slice(1) + " all", "success")
            await loadInstances()
        } else {
            toast("Error: " + r.error, "error")
        }
    }

    /* ──────────────────────────────────────────────────────────────
       EDIT / ADD MODAL
    ────────────────────────────────────────────────────────────── */
    let editingId = null

    function switchModalTab (name, el) {
        document.querySelectorAll(".modal-tab").forEach(t => t.classList.remove("active"))
        document.querySelectorAll(".modal-tab-panel").forEach(p => p.classList.remove("active"))
        el.classList.add("active")
        document.getElementById("mtab-" + name).classList.add("active")
    }

    function openEditModal (id) {
        const inst = instanceCache[id]
        if (!inst) return
        editingId = id
        document.getElementById("edit-modal-title").textContent = "Edit Instance"
        document.getElementById("btn-delete-inst").style.display = ""
        populateForm(inst.cfg || {})
        // Reset to first tab
        document.querySelectorAll(".modal-tab").forEach((t, i) => t.classList.toggle("active", i === 0))
        document.querySelectorAll(".modal-tab-panel").forEach((p, i) => p.classList.toggle("active", i === 0))
        document.getElementById("edit-overlay").classList.add("open")
    }

    function openAddModal () {
        editingId = null
        document.getElementById("edit-modal-title").textContent = "Add Instance"
        document.getElementById("btn-delete-inst").style.display = "none"
        populateForm({})
        document.querySelectorAll(".modal-tab").forEach((t, i) => t.classList.toggle("active", i === 0))
        document.querySelectorAll(".modal-tab-panel").forEach((p, i) => p.classList.toggle("active", i === 0))
        document.getElementById("edit-overlay").classList.add("open")
    }

    function closeModal () {
        document.getElementById("edit-overlay").classList.remove("open")
        editingId = null
    }

    // Defaults mirror the fields[] array in vingester-main.js
    const DEFAULTS = {
        t: "", i: "", w: "1280", h: "720", c: "transparent", z: "1.0",
        H: false, I: false, B: false, S: false,
        ar: false, ai: "300", as: false,
        it: "url", u: "", "if": "", si: "5", sf: "1",
        k: "0", j: "", g: "inline", q: "", G: "inline", Q: "",
        N: false, f: "30", a: false, O: "0", r: 48000, C: "2", o: "0",
        n: true, v: true, l: false,
        m: false, R: "vbr", F: "matroska", M: ""
    }

    function populateForm (cfg) {
        const c = { ...DEFAULTS, ...cfg }

        setVal("f-t",  c.t)
        setVal("f-i",  c.i)
        setVal("f-w",  c.w)
        setVal("f-h",  c.h)
        setVal("f-z",  c.z)
        setVal("f-c",  c.c)
        syncColorSwatch(c.c)

        setChk("f-H", c.H); setChk("f-I", c.I); setChk("f-B", c.B); setChk("f-S", c.S)

        // Input type radio
        const it = c.it || "url"
        const radio = document.querySelector('input[name="inputType"][value="' + it + '"]')
        if (radio) radio.checked = true
        setVal("f-u",   c.u)
        setVal("f-if",  c["if"])
        setVal("f-si",  c.si)
        setVal("f-sf",  c.sf)
        onInputTypeChange()

        // NDI
        setChk("f-N",  c.N)
        setVal("f-f",  c.f)
        setChk("f-a",  c.a)
        setVal("f-O",  c.O)
        setVal("f-r",  String(c.r))
        setVal("f-C",  c.C)
        setVal("f-o",  c.o)
        setChk("f-n",  c.n)
        setChk("f-v",  c.v)
        setChk("f-l",  c.l)
        onNdiToggle()

        // FFmpeg
        setChk("f-m",  c.m)
        setVal("f-R",  c.R)
        setVal("f-F",  c.F)
        setVal("f-M",  c.M)
        onFfmpegToggle()

        // Behavior
        setChk("f-as", c.as)
        setChk("f-ar", c.ar)
        setVal("f-ai", c.ai)
        onArToggle()

        // Patches
        setVal("f-k",  c.k)
        setVal("f-j",  c.j)
        const gType = c.g || "inline"
        setVal("f-g",  gType)
        const GType = c.G || "inline"
        setVal("f-G",  GType)
        setVal("f-q",  c.q)
        setVal("f-Q",  c.Q)
        // If file type, sync file input from code field
        setVal("f-q-file", gType === "file" ? c.q : "")
        setVal("f-Q-file", GType === "file" ? c.Q : "")
        onCssTypeChange(); onJsTypeChange()
    }

    function collectForm () {
        const it = document.querySelector('input[name="inputType"]:checked')?.value || "url"
        const gType = val("f-g")
        const GType = val("f-G")
        return {
            t:  val("f-t"),
            i:  val("f-i"),
            w:  val("f-w"),
            h:  val("f-h"),
            z:  val("f-z"),
            c:  val("f-c"),
            H:  chk("f-H"), I: chk("f-I"), B: chk("f-B"), S: chk("f-S"),
            it,
            u:  val("f-u"),
            "if": val("f-if"),
            si: val("f-si"),
            sf: val("f-sf"),
            k:  val("f-k"),
            j:  val("f-j"),
            g:  gType,
            q:  gType === "file" ? val("f-q-file") : val("f-q"),
            G:  GType,
            Q:  GType === "file" ? val("f-Q-file") : val("f-Q"),
            N:  chk("f-N"),
            f:  val("f-f"),
            a:  chk("f-a"),
            O:  val("f-O"),
            r:  parseInt(val("f-r"), 10) || 48000,
            C:  val("f-C"),
            o:  val("f-o"),
            n:  chk("f-n"),
            v:  chk("f-v"),
            l:  chk("f-l"),
            m:  chk("f-m"),
            R:  val("f-R"),
            F:  val("f-F"),
            M:  val("f-M"),
            as: chk("f-as"),
            ar: chk("f-ar"),
            ai: val("f-ai")
        }
    }

    async function saveInstance () {
        const cfg = collectForm()
        if (!cfg.t.trim()) {
            toast("Title is required", "error")
            return
        }
        if (editingId) {
            const r = await api("/api/instances/" + editingId, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cfg)
            })
            if (r.ok) {
                toast("Saved", "success")
                closeModal()
                await loadInstances()
            } else {
                toast("Save failed: " + r.error, "error")
            }
        } else {
            const r = await api("/api/instances", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(cfg)
            })
            if (r.ok) {
                toast("Instance added", "success")
                closeModal()
                await loadInstances()
            } else {
                toast("Add failed: " + r.error, "error")
            }
        }
    }

    async function deleteCurrentInstance () {
        if (!editingId) return
        const title = val("f-t") || "this instance"
        if (!confirm("Delete '" + title + "'? This cannot be undone.")) return
        const r = await api("/api/instances/" + editingId, { method: "DELETE" })
        if (r.ok) {
            toast("Deleted: " + title, "success")
            closeModal()
            await loadInstances()
        } else {
            toast("Delete failed: " + r.error, "error")
        }
    }

    /* ── Form reactive helpers ─── */
    function onInputTypeChange () {
        const it   = document.querySelector('input[name="inputType"]:checked')?.value || "url"
        const isUrl = it === "url"
        document.getElementById("grp-url").style.display       = isUrl ? "" : "none"
        document.getElementById("grp-files").style.display     = isUrl ? "none" : ""
        document.getElementById("grp-slideshow").style.display = it === "slideshow" ? "" : "none"
    }
    function onNdiToggle () {
        const open = chk("f-N")
        document.getElementById("ndi-collapse").classList.toggle("open", open)
    }
    function onFfmpegToggle () {
        const open = chk("f-m")
        document.getElementById("ffmpeg-collapse").classList.toggle("open", open)
    }
    function onArToggle () {
        const open = chk("f-ar")
        document.getElementById("ar-interval-grp").style.display = open ? "" : "none"
    }
    function onCssTypeChange () {
        const isFile = val("f-g") === "file"
        document.getElementById("grp-css-code").style.display = isFile ? "none" : ""
        document.getElementById("grp-css-file").style.display = isFile ? "" : "none"
    }
    function onJsTypeChange () {
        const isFile = val("f-G") === "file"
        document.getElementById("grp-js-code").style.display = isFile ? "none" : ""
        document.getElementById("grp-js-file").style.display = isFile ? "" : "none"
    }

    /* ── Color picker sync ─── */
    function syncColorSwatch (colorVal) {
        const swatch = document.getElementById("color-swatch")
        const picker = document.getElementById("color-picker")
        if (colorVal && colorVal !== "transparent" && /^#[0-9a-fA-F]{3,6}$/.test(colorVal)) {
            swatch.style.background = colorVal
            picker.value = colorVal
        } else {
            swatch.style.background = "repeating-conic-gradient(#444 0% 25%, #222 0% 50%) 0 0/12px 12px"
            picker.value = "#000000"
        }
    }
    function onColorPicker (v) {
        setVal("f-c", v)
        syncColorSwatch(v)
    }
    function onColorText (v) {
        syncColorSwatch(v)
    }

    /* ──────────────────────────────────────────────────────────────
       MEDIA PICKER
    ────────────────────────────────────────────────────────────── */
    let mediaFiles = []

    async function openMediaPicker () {
        const overlay = document.getElementById("media-picker-overlay")
        const grid    = document.getElementById("picker-grid")
        grid.innerHTML = '<div class="state-msg">Loading&hellip;</div>'
        overlay.classList.add("open")

        const r = await api("/api/media")
        if (!r.ok) {
            grid.innerHTML = '<div class="state-msg">Failed to load media</div>'
            return
        }
        mediaFiles = r.data
        grid.innerHTML = ""
        if (mediaFiles.length === 0) {
            grid.innerHTML = '<div class="state-msg">No media files uploaded yet.</div>'
            return
        }
        for (const f of mediaFiles) {
            const item = document.createElement("div")
            item.className = "picker-item"
            const thumb = f.type === "image"
                ? `<img class="picker-thumb" src="${BASE + f.url}" loading="lazy" alt="${esc(f.name)}"/>`
                : `<video class="picker-thumb" src="${BASE + f.url}" muted preload="metadata"></video>`
            item.innerHTML = thumb + `<div class="picker-name" title="${esc(f.name)}">${esc(f.name)}</div>`
            item.onclick = () => pickMediaFile(f.fullPath || f.name)
            grid.appendChild(item)
        }
    }

    function pickMediaFile (fullPath) {
        const filesEl = document.getElementById("f-if")
        const cur = filesEl.value.trim()
        filesEl.value = cur ? cur + "\n" + fullPath : fullPath
        closeMediaPicker()
    }

    function closeMediaPicker () {
        document.getElementById("media-picker-overlay").classList.remove("open")
    }

    /* ──────────────────────────────────────────────────────────────
       MEDIA MANAGER
    ────────────────────────────────────────────────────────────── */
    async function loadMedia () {
        const grid    = document.getElementById("media-grid")
        const loading = document.getElementById("media-loading")
        const empty   = document.getElementById("media-empty")
        const errBox  = document.getElementById("err-media")

        show(loading)
        hide(grid)
        hide(empty)
        hide(errBox)

        const r = await api("/api/media")
        hide(loading)

        if (!r.ok) {
            errBox.textContent = "Failed to load media: " + r.error
            show(errBox)
            return
        }

        const files = r.data
        if (files.length === 0) { show(empty); return }

        grid.innerHTML = ""
        for (const f of files) {
            const item = document.createElement("div")
            item.className = "media-item"
            const thumb = f.type === "image"
                ? `<img class="media-thumb" src="${BASE + f.url}" loading="lazy" alt="${esc(f.name)}"/>`
                : `<video class="media-thumb" src="${BASE + f.url}" muted preload="metadata"></video>`
            // Build the info row as HTML (static content only)
            item.innerHTML = `
                ${thumb}
                <div class="media-info">
                    <span class="media-name" title="${esc(f.name)}">${esc(f.name)}</span>
                    <span class="media-size">${fmtBytes(f.size)}</span>
                </div>`
            // Attach delete button directly via DOM so listener binds to the element
            const delBtn = document.createElement("button")
            delBtn.className = "media-delete"
            delBtn.title = "Delete"
            delBtn.innerHTML = "&#10005;"
            ;(function (name) {
                delBtn.addEventListener("click", function () { deleteMedia(name) })
            })(f.name)
            item.querySelector(".media-info").appendChild(delBtn)
            grid.appendChild(item)
        }
        show(grid)
    }

    async function deleteMedia (name) {
        if (!confirm("Delete '" + name + "'?")) return
        const r = await api("/api/media/" + encodeURIComponent(name), { method: "DELETE" })
        if (r.ok) { toast("Deleted: " + name, "success"); loadMedia() }
        else      { toast("Delete failed: " + r.error, "error") }
    }

    function onDragOver (ev) {
        ev.preventDefault()
        document.getElementById("upload-zone").classList.add("dragover")
    }
    function onDragLeave () {
        document.getElementById("upload-zone").classList.remove("dragover")
    }
    function onDrop (ev) {
        ev.preventDefault()
        document.getElementById("upload-zone").classList.remove("dragover")
        if (ev.dataTransfer.files.length > 0) uploadFiles(ev.dataTransfer.files)
    }

    async function uploadFiles (fileList) {
        const progress = document.getElementById("upload-progress")
        const bar      = document.getElementById("upload-progress-bar")
        const lbl      = document.getElementById("upload-progress-label")
        show(progress); if (lbl) show(lbl)
        bar.style.width = "0%"

        const files      = Array.from(fileList)
        const totalBytes = files.reduce((sum, f) => sum + f.size, 0) || 1
        let bytesDone    = 0
        let done         = 0

        for (const file of files) {
            const form = new FormData()
            form.append("file", file)

            /*  XHR gives real per-byte upload progress; fetch does not  */
            const r = await new Promise((resolve) => {
                const xhr = new XMLHttpRequest()
                xhr.open("POST", BASE + "/api/media/upload")

                xhr.upload.addEventListener("progress", (e) => {
                    if (!e.lengthComputable) return
                    const pct = Math.round((bytesDone + e.loaded) / totalBytes * 100)
                    bar.style.width = pct + "%"
                    if (lbl) lbl.textContent = file.name + "  \u2014  " + pct + "%"
                })

                xhr.addEventListener("load", () => {
                    bytesDone += file.size
                    try {
                        const data = JSON.parse(xhr.responseText)
                        if (xhr.status >= 200 && xhr.status < 300)
                            resolve({ ok: true, data })
                        else
                            resolve({ ok: false, error: data.error || "HTTP " + xhr.status })
                    }
                    catch (ex) { resolve({ ok: false, error: "Invalid response" }) }
                })
                xhr.addEventListener("error", () => resolve({ ok: false, error: "Network error" }))
                xhr.addEventListener("abort", () => resolve({ ok: false, error: "Upload cancelled" }))
                xhr.send(form)
            })

            if (r.ok) { done++; toast("Uploaded: " + file.name, "success") }
            else      { toast("Upload failed (" + file.name + "): " + r.error, "error") }
        }

        bar.style.width = "100%"
        if (lbl) lbl.textContent = ""
        setTimeout(() => { hide(progress); if (lbl) hide(lbl); bar.style.width = "0%" }, 1200)
        if (done > 0) loadMedia()
    }

    /* ──────────────────────────────────────────────────────────────
       EVENT DELEGATION (replaces all onclick="UI.xxx()" handlers)
    ────────────────────────────────────────────────────────────── */
    document.addEventListener("click", function (e) {
        const btn = e.target.closest("[data-action]")
        if (!btn) return
        const action = btn.dataset.action
        switch (action) {
            case "openAddModal":          openAddModal(); break
            case "closeModal":            closeModal(); break
            case "saveInstance":          saveInstance(); break
            case "deleteCurrentInstance": deleteCurrentInstance(); break
            case "openMediaPicker":       openMediaPicker(); break
            case "closeMediaPicker":      closeMediaPicker(); break
            case "switchTab":             switchTab(btn.dataset.panel, btn); break
            case "switchModalTab":        switchModalTab(btn.dataset.tab, btn); break
            case "cmdInstance":           cmdInstance(btn.dataset.id, btn.dataset.cmd); break
            case "cmdAll":                cmdAll(btn.dataset.cmd); break
            case "openEditModal":         openEditModal(btn.dataset.id); break
            case "deleteMedia":           deleteMedia(btn.dataset.name); break
        }
    })

    /* ──────────────────────────────────────────────────────────────
       CLOSE OVERLAYS ON BACKGROUND CLICK
    ────────────────────────────────────────────────────────────── */
    document.getElementById("edit-overlay").addEventListener("click", function (e) {
        if (e.target === this) closeModal()
    })
    document.getElementById("media-picker-overlay").addEventListener("click", function (e) {
        if (e.target === this) closeMediaPicker()
    })

    /* ──────────────────────────────────────────────────────────────
       AUTO POLL (seamless, no DOM rebuild)
    ────────────────────────────────────────────────────────────── */
    function startPoll () {
        setInterval(async () => {
            if (document.hidden) return
            const active = document.querySelector(".tab-btn.active")
            if (!active || active.textContent.trim() === "Instances") {
                await loadInstances()
            }
        }, 2000)
        /*  refresh immediately when the browser tab becomes visible again  */
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden) loadInstances()
        })
    }

    /* ──────────────────────────────────────────────────────────────
       PUBLIC API (for inline onclick handlers)
    ────────────────────────────────────────────────────────────── */
    window.UI = {
        switchTab, cmdInstance, cmdAll,
        openEditModal, openAddModal, closeModal, saveInstance, deleteCurrentInstance,
        switchModalTab, onInputTypeChange, onNdiToggle, onFfmpegToggle,
        onArToggle, onCssTypeChange, onJsTypeChange,
        onColorPicker, onColorText,
        openMediaPicker, closeMediaPicker, pickMediaFile,
        loadMedia, deleteMedia, uploadFiles, onDragOver, onDragLeave, onDrop
    }

    /* ──────────────────────────────────────────────────────────────
       INIT — Direct button bindings (belt-and-suspenders alongside
       event delegation; bypasses all event bubbling requirements)
    ────────────────────────────────────────────────────────────── */
    ;(function bindStaticButtons () {
        function bind (sel, fn) {
            const els = document.querySelectorAll(sel)
            els.forEach(function (el) { el.addEventListener("click", fn) })
        }
        bind('[data-action="openAddModal"]',          function () { openAddModal() })
        bind('[data-action="closeModal"]',             function () { closeModal() })
        bind('[data-action="saveInstance"]',           function () { saveInstance() })
        bind('[data-action="deleteCurrentInstance"]',  function () { deleteCurrentInstance() })
        bind('[data-action="openMediaPicker"]',        function () { openMediaPicker() })
        bind('[data-action="closeMediaPicker"]',       function () { closeMediaPicker() })
        bind('[data-action="cmdAll"][data-cmd="start"]',  function () { cmdAll("start") })
        bind('[data-action="cmdAll"][data-cmd="stop"]',   function () { cmdAll("stop") })
        bind('[data-action="cmdAll"][data-cmd="reload"]', function () { cmdAll("reload") })
        // Tab bar
        document.querySelectorAll('[data-action="switchTab"]').forEach(function (el) {
            el.addEventListener("click", function () { switchTab(el.dataset.panel, el) })
        })
        // Modal tabs
        document.querySelectorAll('[data-action="switchModalTab"]').forEach(function (el) {
            el.addEventListener("click", function () { switchModalTab(el.dataset.tab, el) })
        })
    })()

    loadInstances()
    startPoll()
    setInterval(() => {
        document.getElementById("status-time").textContent =
            new Date().toLocaleTimeString()
    }, 1000)

})();
</script>
</body>
</html>
